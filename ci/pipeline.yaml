groups:
  - name: master 
    jobs:
      - build
      - test
      - staging
      - eu-de-1
  - name: cli
    jobs:
      - test-cli
      - build-cli
jobs:
  - name: build 
    serial: true
    public: true
    plan:
      - aggregate:
        - get: lyra.git
          trigger: true
        - get: lyra.version
          params: { bump: true }
      - put: lyra.image
        params:
          build: lyra.git/
          dockerfile: lyra.git/docker/Dockerfile
          tag_as_latest: true
          cache: true
          cache_tag: latest
          tag: lyra.version/current
      - put: lyra.version
        params: { filename: lyra.version/current }
  - name: test
    public: true
    plan:
      - aggregate:
        - get: lyra.image
          passed: [ build ]
        - get: lyra.git
          passed: [ build ]
          trigger: true
        - get: lyra.version
          passed: [ build ]
      - task: rspec 
        file: lyra.git/ci/tasks/unit-tests.yaml
        image: lyra.image

  - name: staging
    serial: true
    plan:
      - aggregate:
        - get: lyra.git
          trigger: true
          passed: [ test ]
        - get: lyra.version
          passed: [ test ]
        - get: lyra.image
          passed: [ test ]
      - task: deploy-api
        file: lyra.git/ci/tasks/deployment.yaml 
        params:
          REGION: staging 
          GITHUB_TOKEN: {{github-access-token}}
          DEPLOYMENT: api
      - task: deploy-worker
        file: lyra.git/ci/tasks/deployment.yaml 
        params:
          REGION: staging 
          GITHUB_TOKEN: {{github-access-token}}
          DEPLOYMENT: worker

  - name: eu-de-1
    serial: true
    plan:
      - aggregate:
        - get: lyra.git
          passed: [ staging ]
          trigger: true
        - get: lyra.version 
          passed: [ staging ]
        - get: lyra.image
          passed: [ test ]
      - task: deploy-api
        file: lyra.git/ci/tasks/deployment.yaml 
        params:
          REGION: staging 
          GITHUB_TOKEN: {{github-access-token}}
          DEPLOYMENT: api
      - task: deploy-worker
        file: lyra.git/ci/tasks/deployment.yaml 
        params:
          REGION: staging 
          GITHUB_TOKEN: {{github-access-token}}
          DEPLOYMENT: worker


  - name: test-cli
    plan:
      - get: cli.git 
        trigger: true
      - task: test-cli
        file: cli.git/ci/tests.yml

  - name: build-cli
    serial: true
    plan:
      - get: cli.git 
        passed: [test-cli]
        trigger: true
      - get: cli.version
        params: { bump: true }
      - aggregate:
        - task: build-linux
          file: cli.git/ci/build.yml
          output_mapping: { binary: binary-linux }
        - task: build-windows
          file: cli.git/ci/build.yml
          output_mapping: { binary: binary-windows }
          params: { GOOS: windows }
        - task: build-darwin
          file: cli.git/ci/build-darwin.yml
          output_mapping: { binary: binary-darwin }
      - task: prepare-release
        file: cli.git/ci/prepare-release.yml
      - aggregate:
        - put: cli.version
          params: { filename: cli.version/current }
        - put: cli-release
          params:
            name: release/name
            tag: cli.version/current
            tag_prefix: v
            body: release/body
            commitsh: release/commitsh
            globs: [release/artifacts/*]


resources:
  - name: lyra.git
    type: git
    source:
      uri: git://gitHub.***REMOVED*** /monsoon/monsoon-automation.git
      branch: master
  - name: lyra.image
    type: docker-image
    source:
      host:       {{docker-registry-host}}
      username:   {{docker-registry-username}}
      password:   {{docker-registry-password}}
      repository: hub.***REMOVED***/monsoon/lyra
  - name: lyra.version
    type: monsoon-version
    source: 
      key:  automation 
      initial:   "00010101"
      username:  {{swift-username}}
      api_key:   {{swift-api-key}}
      auth_url:  {{swift-auth_url}}
      domain:    {{swift-domain}}
      tenant_id: {{swift-project-id}}
      container: {{swift-container-version}}
  - name: cli.git 
    type: git
    source:
      uri: git://gitHub.***REMOVED*** /monsoon/lyra-cli.git
      branch: master
  - name: cli.version
    type: monsoon-version
    source: 
      key:  lyra-cli 
      initial:   "00010101"
      username:  {{swift-username}}
      api_key:   {{swift-api-key}}
      auth_url:  {{swift-auth_url}}
      domain:    {{swift-domain}}
      tenant_id: {{swift-project-id}}
      container: {{swift-container-version}}
  - name: cli-release
    type: github-release 
    source:
      github_api_url: https://gitHub.***REMOVED*** /api/v3/
      github_uploads_url: https://gitHub.***REMOVED*** /api/uploads/
      user: monsoon 
      repository: lyra-cli 
      access_token: {{github-access-token}}


resource_types:
  - name: monsoon-version
    type: docker-image
    source:
      repository: hub.***REMOVED***/concourse/monsoon-version
        
  - name: github-release 
    type: docker-image
    source:
      repository: hub.***REMOVED***/concourse/github-release-resource
